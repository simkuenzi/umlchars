<html th:replace="~{layout :: layout(~{::title}, ~{::div})}" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>UML Chars</title>
    <link rel="stylesheet" href="../../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="body">
<div>
    <form class="form" method="post">

        <div class="tab">
            <button class="tab-button-active" type="button" onclick="showTab(this, 'classes-tab')">Classes</button>
            <button class="tab-button" type="button" onclick="showTab(this, 'associations-tab')">Associations</button>
        </div>

        <div id="classes-tab" class="tab-content-active">
            <div id="classes"></div>
            <div class="form-row form-row-action">
                <button type="button" onclick="addClass()">Add Class</button>
            </div>
        </div>

        <div id="associations-tab" class="tab-content">
            <div id="associations"></div>
            <div class="form-row form-row-action">
                <button type="button" onclick="addAssoc()">Add Association</button>
            </div>
        </div>


        <div class="form-row form-row-action">
            <span class="form-action-message" th:if="${form.valid} == false" th:text="${form.message}">Invalid Input</span>
            <button type="submit">Submit</button>
        </div>
    </form>

    <div>
        <pre th:text="${uml}">
            +-------+   +-------+
            | Hello |---| World |
            +-------+   +-------+
        </pre>
    </div>

    <div hidden id="classTemplate">
        <div class="form-row form-row-action">
            <button type="button" onclick="removeClass(this)"><i class="fa fa-trash"></i></button>
        </div>
        <div class="form-row">
            <div class="form-label"><label for="className">Class name</label></div>
            <div class="form-input">
                <input id="className" name="className" type="text" />
                <div class="form-input-message">
                </div>
            </div>
        </div>
    </div>

    <div hidden id="assocTemplate">
        <div class="form-row form-row-action">
            <button type="button" onclick="removeAssoc(this)"><i class="fa fa-trash"></i></button>
        </div>
        <div class="form-row">
            <div class="form-label"><label for="assocFrom">From</label></div>
            <div class="form-input">
                <select id="assocFrom" name="assocFrom">
                    <option value="a">a</option>
                    <option value="b">b</option>
                </select>
                <div class="form-input-message">
                </div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-label"><label for="assocTo">To</label></div>
            <div class="form-input">
                <select id="assocTo" name="assocTo">
                    <option value="a">a</option>
                    <option value="b">b</option>
                </select>
                <div class="form-input-message">
                </div>
            </div>
        </div>
    </div>

    <script language="JavaScript" th:inline="javascript">
        var classNames = [
            /*[# th:each="className, stat : ${form.classNames}"]*/
            {
                "value": /*[[${className.value}]]*/ "",
                "valid": /*[[${className.valid}]]*/ true,
                "message": /*[[${className.message}]]*/ ""
            } /*[(${stat.size-1 > stat.index} ? ',':'')]*/
            /*[/]*/
        ];

        var assocs = [
            /*[# th:each="assocFrom, stat : ${form.assocFroms}"]*/
            {
                "assocFrom": {
                    "value": /*[[${assocFrom.value}]]*/ "",
                    "valid": /*[[${assocFrom.valid}]]*/ true,
                    "message": /*[[${assocFrom.message}]]*/ ""
                },
                "assocTo": {
                    "value": /*[[${form.assocTos[stat.index].value}]]*/ "",
                    "valid": /*[[${form.assocTos[stat.index].valid}]]*/ true,
                    "message": /*[[${form.assocTos[stat.index].message}]]*/ ""
                }
            } /*[(${stat.size-1 > stat.index} ? ',':'')]*/
            /*[/]*/
        ];
    </script>

    <script language="JavaScript">
        function showTab(b, id) {
            var active = document.getElementsByClassName("tab-content-active");
            for (var i = 0; i < active.length; i++) {
                active[i].setAttribute("class", "tab-content");
            }

            document.getElementById(id).setAttribute("class", "tab-content-active");

            var tabs = b.parentElement;
            for (var i = 0; i < tabs.children.length; i++) {
                tabs.children[i].setAttribute("class", "tab-button");
            }
            b.setAttribute("class", "tab-button-active");
        }

        function removeClass(b) {
            b.parentElement.parentElement.remove();
            adjustAttributesOnClasses();
        }

        function initClass(i, o) {
            var templateNode = document.getElementById("classTemplate");
            var node = templateNode.cloneNode(true);
            node.removeAttribute("hidden");
            node.setAttribute("class", "form-section");
            node.children.item(1).children.item(1).children.item("className").setAttribute("value", o.value);
            node.children.item(1).children.item(1).setAttribute("class", o.valid ? "form-input" : "form-input-active form-input");
            node.children.item(1).children.item(1).children.item(1).innerHTML = o.message;
            adjustAttributes(node, templateNode, i);
            document.getElementById("classes").appendChild(node);
        }

        function addClass() {
            initClass(classCount(), { "value": "", "valid": true, "message": "" });
        }

        function classCount() {
            var c = 0;
            var node = document.getElementById("classes");
            for (var i in node.children) {
                if (node.children[i].nodeType == 1) {
                    c++;
                }
            }
            return c;
        }

        function adjustAttributesOnClasses() {
            var div = document.getElementById("classes");
            var templateNode = document.getElementById("classTemplate");
            for (var i in div.children) {
                if (div.children[i].nodeType == 1) {
                    adjustAttributes(div.children[i], templateNode, i);
                }
            }
        }

        function removeAssoc(b) {
            b.parentElement.parentElement.remove();
            adjustAttributesOnAssocs();
        }

        function initAssoc(i, o) {
            var templateNode = document.getElementById("assocTemplate");
            var node = templateNode.cloneNode(true);
            node.removeAttribute("hidden");
            node.setAttribute("class", "form-section");
            initField(node.children.item(1).children.item(1), o.assocFrom);
            initField(node.children.item(2).children.item(1), o.assocTo);
            adjustAttributes(node, templateNode, i);
            document.getElementById("associations").appendChild(node);
        }

        function initField(node, o) {
            node.children.item(0).setAttribute("value", o.value);
            var options = node.children.item(0).children;
            for (var i = 0; i < options.length; i++) {
                if (options[i].nodeType == 1) {
                    if (options[i].getAttribute("value") == o.value) {
                        options[i].setAttribute("selected", "");
                    } else {
                        options[i].removeAttribute("selected");
                    }
                }
            }
            node.setAttribute("class", o.valid ? "form-input" : "form-input-active form-input");
            node.children.item(1).innerHTML = o.message;
        }

        function addAssoc() {
            initAssoc(assocCount(), { "assocFrom": {value: "", "valid": true, "message": "" }, "assocTo": {value: "", "valid": true, "message": "" }} );
        }

        function assocCount() {
            var c = 0;
            var node = document.getElementById("associations");
            for (var i in node.children) {
                if (node.children[i].nodeType == 1) {
                    c++;
                }
            }
            return c;
        }

        function adjustAttributesOnAssocs() {
            var div = document.getElementById("associations");
            var templateNode = document.getElementById("assocTemplate");
            for (var i in div.children) {
                if (div.children[i].nodeType == 1) {
                    adjustAttributes(div.children[i], templateNode, i);
                }
            }
        }

        function adjustAttributes(node, templateNode, index) {
            adjustAttribute(node, templateNode, "id", index);
            adjustAttribute(node, templateNode, "name", index);
            adjustAttribute(node, templateNode, "for", index);

            for (var i in node.children) {
                if (node.children[i].nodeType == 1) {
                    adjustAttributes(node.children[i], templateNode.children[i], index);
                }
            }
        }

        function adjustAttribute(node, templateNode, attributeName, index) {
            if (node.hasAttribute(attributeName)) {
                node.setAttribute(attributeName, templateNode.getAttribute(attributeName) + index);
            }
        }

        for (var i in classNames) {
            initClass(i, classNames[i]);
        }

        for (var i in assocs) {
            initAssoc(i, assocs[i]);
        }

        if (classCount() == 0) {
            addClass();
        }

    </script>

</div>
</body>
</html>