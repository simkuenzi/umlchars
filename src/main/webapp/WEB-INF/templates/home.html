<html th:replace="~{layout :: layout(~{::title}, ~{::div})}" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>UML Chars</title>
    <link rel="stylesheet" href="../../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="body">
<div>
    <form class="form" method="post">
        <input id="classCount" name="classCount" th:value="${form.classCount}" value="1" type="hidden" />
        <div id="classes"></div>
        <div class="form-row form-row-action">
            <button type="button" onclick="addClass()">Add Class</button>
        </div>
        <div class="form-row form-row-action">
            <span class="form-action-message" th:if="${form.valid} == false" th:text="${form.message}">Invalid Input</span>
            <button type="submit">Submit</button>
        </div>
    </form>

    <div>
        <pre th:text="${uml}">
            +-------+   +-------+
            | Hello |---| World |
            +-------+   +-------+
        </pre>
    </div>

    <div hidden id="classTemplate">
        <div class="form-row form-row-action">
            <button type="button" onclick="removeClass(this)"><i class="fa fa-trash"></i></button>
        </div>
        <div class="form-row">
            <div class="form-label"><label for="className">Class name</label></div>
            <div class="form-input">
                <input id="className" name="className" type="text" />
                <div class="form-input-message">
                </div>
            </div>
        </div>
    </div>

    <script language="JavaScript" th:inline="javascript">
        var classNames = [
            /*[# th:each="className, stat : ${form.classNames}"]*/
            {
                "value": /*[[${className.value}]]*/ "",
                "valid": /*[[${className.valid}]]*/ true,
                "message": /*[[${className.message}]]*/ ""
            } /*[(${stat.size-1 > stat.index} ? ',':'')]*/
            /*[/]*/
        ];
    </script>

    <script language="JavaScript">
        function removeClass(b) {
            b.parentElement.parentElement.remove();
            adjustAttributesOnClasses();
            decClassCount();

        }

        function initClass(i, o) {
            var templateNode = document.getElementById("classTemplate");
            var node = templateNode.cloneNode(true);
            node.removeAttribute("hidden");
            node.setAttribute("class", "form-section");
            node.children.item(1).children.item(1).children.item("className").setAttribute("value", o.value);
            node.children.item(1).children.item(1).setAttribute("class", o.valid ? "form-input" : "form-input-active form-input");
            node.children.item(1).children.item(1).children.item(1).innerHTML = o.message;
            adjustAttributes(node, templateNode, i);
            document.getElementById("classes").appendChild(node);
        }

        function addClass() {
            initClass(classCount(), { "value": "", "valid": true, "message": "" });
            incClassCount();
        }

        function classCount() {
            return parseInt(document.getElementById("classCount").getAttribute("value"));
        }

        function incClassCount() {
            document.getElementById("classCount").setAttribute("value", classCount() + 1);
        }

        function decClassCount() {
            document.getElementById("classCount").setAttribute("value", classCount() - 1);
        }

        function adjustAttributesOnClasses() {
            var div = document.getElementById("classes");
            var templateNode = document.getElementById("classTemplate");
            for (var i in div.children) {
                if (div.children[i].nodeType == 1) {
                    adjustAttributes(div.children[i], templateNode, i);
                }
            }
        }

        function adjustAttributes(node, templateNode, index) {
            adjustAttribute(node, templateNode, "id", index);
            adjustAttribute(node, templateNode, "name", index);
            adjustAttribute(node, templateNode, "for", index);

            for (var i in node.children) {
                if (node.children[i].nodeType == 1) {
                    adjustAttributes(node.children[i], templateNode.children[i], index);
                }
            }
        }

        function adjustAttribute(node, templateNode, attributeName, index) {
            if (node.hasAttribute(attributeName)) {
                node.setAttribute(attributeName, templateNode.getAttribute(attributeName) + index);
            }
        }


        if (classCount() == 0) {
            addClass();
        }

        for (var i in classNames) {
            initClass(i, classNames[i]);
        }
    </script>

</div>
</body>
</html>